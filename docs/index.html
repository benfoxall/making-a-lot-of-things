<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Making a lot of things</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="lib/reveal.js/css/reveal.css">
    <link rel="stylesheet" href="lib/reveal.js/css/theme/black.css">
    <link rel="stylesheet" href="lib/reveal.js/lib/css/zenburn.css">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>

    <!-- <pre><code class="javascript" data-trim>
        console.log("some code")
      </code></pre> -->

    <div class="reveal">
      <div class="slides">
        <section>
          <h1>Making a lot of things</h1>
        </section>
        <section>
          <section>
            <h1>Thanks</h1>
          </section>
        </section>
        <section>
          <section>
            <h1>Hi, I'm Ben</h1>
            <h3>Developer/Adventurer based in Oxford, UK</h3>
          </section>
          <section>
            <h2>You might know me from …</h2>
            <h2>2014 - FutureJS</h2>
            <h2>2015 - Full Stack Fest</h2>
            <h2>2016 - Full Stack Fest (microtalk)</h2>
          </section>
        </section>
        <section>
          <section>
            <h1>Demos</h1>
            <p>[phones]</p>
          </section>
          <section>
            <h1>[light hacks]</h1>
          </section>
          <section>
            <h2>This is not a demo talk</h2>
          </section>
        </section>

        <section>
          <section>
            <h1>Making a lot of things</h1>
          </section>
        </section>

        <section>
          <section>
            <h1>#microhacks</h1>
          </section>

          <!-- <section>
            <h1>[the button]</h1>
          </section> -->
          <section>
            <h1>[dither]</h1>
          </section>
          <section>
            <h1>[cursory-hack]</h1>
          </section>
          <section>
            <h1>[cubes]</h1>
          </section>
          <section>
            <h1>[scan]</h1>
          </section>
          <section>
            <h1>[cardboctober]</h1>
          </section>
          <section>
            <h1>[webgl-hacks]</h1>
          </section>
          <!-- <section>
            <h1>[audio-stereograph]</h1>
          </section> -->
        </section>

        <section>
          <section>
            <h1>Benefits</h1>
          </section>
          <section>
            <h3>Satifying</h3>
            <h3>Fun</h3>
            <h3>Understanding libraries &amp; APIs</h3>
            <h3>Exploring ideas</h3>
            <h3>Small things can lead to bigger things</h3>
          </section>
          <section>
            <h3>[ruby]</h3>
            <h3>[publishing rooms]</h3>
          </section>
        </section>

        <section>
          <section>
            <h1>What features enhance creativity?</h1>
          </section>
          <section>
            <h1>1. Exploration</h1>
            <h1>2. Constraint</h1>
          </section>
          <section>
            <h1>[igor]</h1>
          </section>
          <section>
            <blockquote>My freedom thus consists in my moving about within the narrow frame that I have assigned to myself for each one of my undertakings. I shall go even further: my freedom will be so much the greater and more meaningful the more narrowly I limit my field of action and the more I surround myself with obstacles. Whatever diminishes constraint diminishes strength. The more constraints one imposes, the more one frees oneself of the claims that shackle the spirit.</blockquote>
            <cite>Igor Stravinsky</cite>
          </section>

          <section>
            <h1>Constraint breeds creativity</h1>
          </section>
        </section>

        <section>
          <section>
            <h2>Today: changing constraints</h2>
            <h1>1. Coding</h1>
            <h1>2. Making</h1>
          </section>
        </section>

        <section>
          <section>
            <h1>Coding</h1>
          </section>
          <section>
            <img class="stretch" src="images/screen-complex-code.png" />
          </section>

          <section>
            <img class="stretch" src="images/screen-complex-frameworks.png" />
          </section>

          <section>
            <img class="stretch" src="images/sk-repls.png" />
          </section>

          <section>
            <img class="stretch" src="images/sk-repl-svelte.png" />
          </section>

          <section>
            <h1>cojs.co</h1>
            <img class="stretch" src="images/screen-repl-cojs.png" />
          </section>
        </section>

        <section>
          <section>
            <h1>Evaluating JavaScript</h1>
          </section>

          <section>
            <img class="stretch" src="images/sk-cell-outline.png" />
          </section>

          <section>
            <h1>JavaScript ⊂ Text</h1>
          </section>

          <section>
            <h3>How do we test if text is JavaScript?</h3>
          </section>

          <section>
            <!-- <h1>Is our text JavaScript?</h1> -->
            <h2>Text → Tokens → Abstract Syntax Tree</h2>
          </section>


          <script src="https://unpkg.com/esprima@~4.0/dist/esprima.js"></script>

          <section id="parsing">
            <textarea id="textarea"></textarea>
            <div class="output" id="token_out"></div>
            <div class="output" id="tree_out"></div>

            <script type="text/javascript">
              textarea.addEventListener('keyup', () => {
                try {
                  const v = esprima.tokenize(textarea.value)
                  token_out.innerText = JSON.stringify(v)
                } catch (e) {
                  token_out.innerText = '[]'
                }

                tree_out.style.color = ''
                try {
                  const v = esprima.parse(textarea.value)
                  tree_out.innerText = JSON.stringify(v)
                } catch (e) {
                  tree_out.style.color = 'red'
                  tree_out.innerText = e.toString()
                }
              })
            </script>
          </section>


          <section>
            <pre><code class="javascript" data-trim>
              if(!is_javascript(src)) return

              const htm = `
                &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;
                &lt;script&gt;
                  const output = ${src}

                  /* todo: print output */
                &lt;/script&gt;
                &lt;/body&gt;&lt;/html&gt;
              `

              const blob = new Blob([htm], {type: 'text/html'})
              const url = URL.createObjectURL(blob)
              iframe.src = url

            </code></pre>
          </section>

          <section>
            <h1>It works!</h1>
            <h3>…ish</h3>
          </section>

          <section>
            <h1>only for simple expressions</h1>
          </section>

          <section>
            <pre class="big"><code class="javascript" data-trim>
            const output =
                x = 10
                y = 32
                x + y
            </code></pre>

            <h2 class="fragment" style="margin-top:1em;">= 10</h2>
          </section>

          <section>
            <h1>Modify our syntax tree</h1>
          </section>

          <section>
            <pre><code class="javascript" data-trim>
                x = 10
                y = 32
                x + y
            </code></pre>

            <pre data-trim><code data-trim>
            Program
              ExpressionStatement
                AssignmentExpression
                  Operator (=)
                  Identifier (x)
                  Literal (10)
              ExpressionStatement
                AssignmentExpression
                  Operator (=)
                  Identifier (y)
                  Literal (32)
              ExpressionStatement
                BinaryExpression
                  Operator (+)
                  Identifier (x)
                  Identifier (y)
              </code></pre>
          </section>

          <section data-transition="none">
            <img src="images/ast-rewrite-1.png" class="stretch" />
          </section>
          <section data-transition="none">
            <img src="images/ast-rewrite-2.png" class="stretch" />
          </section>
          <section data-transition="none">
            <img src="images/ast-rewrite-3.png" class="stretch" />
          </section>

          <script src="lib/recast.js"></script>
          <script src="lib/types.js"></script>
          <section id="types">
            <textarea id="textarea_type">x = 1
y = 1
z = x + y</textarea>
            <div class="output" id="type_out"></div>

            <script type="text/javascript">
              textarea_type.addEventListener('keyup', () => {
                try {
                  const b = types.builders

                  const ast = recast.parse(textarea_type.value)

                  types.visit(ast, {
                    visitVariableDeclaration: function(path) {

                      path.node.declarations.forEach((d, i) => {
                        const wrap = b.callExpression(
                            b.identifier("O_"),
                            [d.init]
                          )

                        path.get("declarations", i)
                          .get('init')
                          .replace(wrap)

                      })

                      this.traverse(path)
                    },


                    visitExpressionStatement: function(path) {
                      const wrap = b.callExpression(
                          b.identifier("O_"),
                          [path.node.expression]
                        )
                      path.get('expression').replace(wrap)
                      this.traverse(path)
                    },

                    visitAssignmentExpression: function(path) {
                      const wrap = b.callExpression(
                          b.identifier("O_"),
                          [path.node.right]
                        )
                      path.get('right').replace(wrap)
                      this.traverse(path)
                    }

                  })

                  const out = recast.print(ast).code

                  type_out.innerText = out
                } catch (e) {
                  console.log(e)
                  type_out.innerText = e.message
                }
              })
            </script>
          </section>


          <section>
            <h1>ast-tools &amp; recast</h1>
          </section>

          <section>
            <pre class="big"><code class="javascript" data-trim>
                x = 10
                y = 32
                x + y
            </code></pre>
            <h1>↓</h1>

            <pre class="big"><code class="javascript" data-trim>
                O(x = O(10))
                O(y = O(32))
                O(O(x) + O(y))
            </code></pre>
          </section>


          <script>
            // cojs message handling
              window.addEventListener('message', (e) => {
                const data = e.data

                if(!data.action) return console.error("no action type from embed message")

                document.querySelectorAll('iframe').forEach(frame => {
                  if(frame.contentWindow === e.source) {

                    if(e.data.action === 'ready') {
                      frame.contentWindow.postMessage({
                        action: 'config',
                        value: {
                          bodyStyle: {
                            backgroundColor: '#333'
                          },
                          config: frame.dataset.config
                        }
                      }, '*')
                    }

                    if(e.data.action === 'key') {
                      if(e.data.value == 'PageUp') {
                        Reveal.prev()
                      } else {
                        Reveal.next()
                      }
                    }
                  }
                })
              })
          </script>


          <section class="cojs-embed">
            <iframe
              src="http://localhost:8080/"
              sandbox="allow-same-origin allow-scripts"
              data-config="no-add"
            ></iframe>
            <script type="cojs/javascript" data-ref="0" data-trim>
              x = 10
              y = 32
              x + y
            </script>
          </section>

          <section>
            <h1>The best way to let someone understand something, it to let them explore it</h1>
          </section>
        </section>






        <!--
          There's a reason why so many seminal works of art start off on the back of a bar napkin…

          …It's because they were in a bar.

          James Victore
          https://gumroad.com/l/xrpoM
        -->
      </div>
    </div>

    <script src="lib/reveal.js/lib/js/head.min.js"></script>
    <script src="lib/reveal.js/js/reveal.js"></script>

    <script src="lib/slide-builder.js"></script>

    <script>

      Reveal.initialize({
        controls: false,
        progress: false,
        history: true,
        center: true,
        // margin: 0,
        width: 1920,
        height: 1080,

        transition: 'slide',

        dependencies: [
          {
            src: 'lib/reveal.js/plugin/highlight/highlight.js',
            callback: function() { hljs.initHighlightingOnLoad() }
          }

        ]
      })



      // Function to perform a better "data-trim" on code snippets
    	// Will slice an indentation amount on each line of the snippet (amount based on the line having the lowest indentation length)
    	function betterTrim(snippetEl) {
    		// Helper functions
    		function trimLeft(val) {
    			// Adapted from https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/Trim#Polyfill
    			return val.replace(/^[\s\uFEFF\xA0]+/g, '');
    		}
    		function trimLineBreaks(input) {
    			var lines = input.split('\n');

    			// Trim line-breaks from the beginning
    			for (var i = 0; i < lines.length; i++) {
    				if (lines[i].trim() === '') {
    					lines.splice(i--, 1);
    				} else break;
    			}

    			// Trim line-breaks from the end
    			for (var i = lines.length-1; i >= 0; i--) {
    				if (lines[i].trim() === '') {
    					lines.splice(i, 1);
    				} else break;
    			}

    			return lines.join('\n');
    		}

    		// Main function for betterTrim()
    		return (function(snippetEl) {
    			var content = trimLineBreaks(snippetEl.innerHTML);
    			var lines = content.split('\n');
    			// Calculate the minimum amount to remove on each line start of the snippet (can be 0)
    			var pad = lines.reduce(function(acc, line) {
    				if (line.length > 0 && trimLeft(line).length > 0 && acc > line.length - trimLeft(line).length) {
    					return line.length - trimLeft(line).length;
    				}
    				return acc;
    			}, Number.POSITIVE_INFINITY);
    			// Slice each line with this amount
    			return lines.map(function(line, index) {
    				return line.slice(pad);
    			})
    			.join('\n');
    		})(snippetEl);
    	}





      document.querySelectorAll('.cojs-embed')
      .forEach(section => {
        const builder = new SlideBuilder(section)

        const frame = section.querySelector('iframe')

        builder.fragments(
          Array.from(section
            .querySelectorAll('script[type="cojs/javascript"]')
          )
          .map(script =>
            () => {
              const trimmed = betterTrim(script)
              frame.contentWindow.postMessage({
                action: 'add',
                value: {
                  code: trimmed,
                  ref: script.dataset.ref
                }
              }, '*')
            }
          )
        )


      })

    </script>

  </body>
</html>
